!!! note
    Applicable for director version <<DIRECTOR VERSION HERE>>+

# Rotating Application Certificates

The goal of this document is to guide the operator through a series of steps to take for rotating their application certificates.

It is highly recommended that the operator is aware of the releases and their behviour with concatenated CA certificates.

### Step n: Prepare for recreation

The resurrector should be disabled for the rotation. This is a precaution such that in the event a dependent deployment was missed during a step, the resurrector will not try to recreate the instance.

`bosh update-resurrection off`

Use api endpoint `/deployment/:name/rotate_certificates?action=plan` to help determine the dependencies of the deployment.

`bosh curl /deployment/target_deployment/rotate_certificates?action=plan`

The following information will be returned:
- Deployment which consumes from the targeted deployment (naive check)
- CA certificates that will be regenerated
- CA certificates that are already in transitional state
- Leaf certificates that will be affected 

```
Details on how a sample response may look like.
{}
```

### Step n: Generate new CA certificates (Prepare for transition)

Use api endpoint `/deployment/:name/rotate_certificates?action=generate&type=ca` to generate new CA certificates as described by the previous end point.

`bosh curl /deployment/target_deployment/rotate_certificates?action=generate&type=ca`

The endpoint will return the following:
- Error if any CA is already transitional
  - This implies there is a rotation already in progress
  - Maybe only if the old CA is marked transitional
- A list of CA certificates that were affected

This api call is currently not idempotent.

Note:
For manually uploaded certificates on credhub it will be the operator's responsibility to update them with new CA certificates and set the transitional flag on the new CA certificate.

### Step n: Recreate Target deployment and dependent deployments

The target deployment should be redeployed. Upon success, the dependent deployments must also be redeployed.

```
bosh -d target_deployment deploy target_deployment.yml
bosh -d dependent_deployment_1 deploy dependent_deployment_1.yml
bosh -d dependent_deployment_2 deploy dependent_deployment_2.yml
```

A dependent deployment is one which satisfied one or more of the following conditions:
- It consumes from a shared provider in the targeted deployment.
- It uses a global variable generated by the targeted deployment.

### Step n: Generate new leaf certificates

Use api endpoint `/deployment/:name/rotate_certificates?action=generate&type=leaf` to regenerate leaf certificates with new CA certificate.

`bosh curl /deployment/target_deployment/rotate_certificates?action=generate&type=leaf`

This api call is idempotent.

Note:
For manually uploaded leaf certificates on credhub it will be the operator's responsibility to update them with new certificates.

### Step n: Recreate Target deployment and dependent deployments

The target deployment should be redeployed. Upon success, the dependent deployments must also be redeployed.

```
bosh -d target_deployment deploy target_deployment.yml
bosh -d dependent_deployment_1 deploy dependent_deployment_1.yml
bosh -d dependent_deployment_2 deploy dependent_deployment_2.yml
```

A dependent deployment is one which satisfied one or more of the following conditions:
- It consumes from a shared provider in the targeted deployment.
- It uses a global variable generated by the targeted deployment.

### Step n: Transition Fully to New CA Certificate

Use api endpoint `/deployment/:name/rotate_certificates?action=transition&type=ca`

`bosh curl /deployment/target_deployment/rotate_certificates?action=transition&type=ca`

This api call is idempotent.

Note:
For manually uploaded CA certificates on credhub it will be the operator's responsibility to remove the transitional flag from the old CA certificate.

### Step n: Recreate Target deployment and dependent deployments

The target deployment should be redeployed. Upon success, the dependent deployments must also be redeployed.

```
bosh -d target_deployment deploy target_deployment.yml
bosh -d dependent_deployment_1 deploy dependent_deployment_1.yml
bosh -d dependent_deployment_2 deploy dependent_deployment_2.yml
```

A dependent deployment is one which satisfied one or more of the following conditions:
- It consumes from a shared provider in the targeted deployment.
- It uses a global variable generated by the targeted deployment.

### Step n: Re-enable Resurrector

The resurrector should be re-enabled at this point.

`bosh update-resurrection on`

## Recovering from failed deploy
When a deploy fails and one of the API calls were triggered, the only option is to move forward. As there is already downtime, we should proceed with the steps.
